{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    #pay_body {
        width:100%;
        height:100vh;
        font-family:넥슨 고딕;
    }
    #pay_body > #header {
        font-family:넥슨 고딕 bold;
        color: white;
        height:20%;
        min-height:150px;
        max-height:200px;
        background-color: #58C9B9;
        position: relative;
    }

    #pay_body > #footer > #pay_submit {
        background-color:#58C9B9; color:white;
        width:100%; height:50px;border:none;
        font-family:넥슨 고딕 bold;
        font-size:21px;
    }

    #pay_body > #header > #title {
        font-size: 28px;
        width:100%;
        text-align: center;
        position: absolute;
        top: 20px;
    }

    #pay_body > #header > #my_point {
        width:100%;
        font-family:넥슨 고딕 bold;
        font-size: 21px;
        text-align: center;
        position: absolute;
        bottom: 20px;
    }
    #pay_body > #body {
        overflow:scroll; 
        width:100%;
        padding:20px;
    }
    
    #pay_body > #body > #inputPoint {
        margin-bottom: 30px !important;
    }

    #pay_body > #footer {
        position:absolute;
        bottom:62px;
        width:100%;
        height:auto;   
        background-color:#e2e2e2;
    }

    #pay_body > #footer > #info {
        text-align: left;
        margin-top: 20px;
        padding: 0px 20px;
        font-size:18px;
        color:#7e7e7e;
    }

    #method {
        text-align: right;
    }
    #total_fee {
        text-align: right;
    }
</style>

<div id="pay_body">
    <div id="header">
        <div id="title">포인트 결제</div>
        <div id="my_point">
            현재 내 포인트 10,000P
        </div>
    </div>

    <div id="body" >
        <label for="inputPoint" class="form-label">충전할 포인트를 선택하세요</label>
        <select class="form-select form-select mb-3" id="inputPoint" aria-label=".form-select-lg example">
            <option selected>충전할 포인트를 선택하세요.</option>
            <option value="1000">1,000 포인트</option>
            <option value="3000">3,000 포인트</option>
            <option value="5000">5,000 포인트</option>
            <option value="10000">10,000 포인트</option>
            <option value="30000">30,000 포인트</option>
            <option value="50000">50,000 포인트</option>
            <option value="100000">100,000 포인트</option>
        </select>

        <label for="inputPoint" class="form-label">결제수단을 선택하세요.</label>
        <ul class="list-group" id="inputMethods">

            <label for="card">
                <li class="list-group-item">
                    <input class="form-check-input me-1" id="card" name="inputMethod" type="radio" value="card" aria-label="...">
                        신용카드 / 간편결제
                </li>
            </label>
            <label for="vbank">
                    <li class="list-group-item">
                        <input class="form-check-input me-1" id="vbank" name="inputMethod" type="radio" value="vbank" aria-label="...">
                            무통장 입금
                    </li>
            </label>

            <label for="phone">
                <li class="list-group-item">
                    <input class="form-check-input me-1" id='phone' name="inputMethod" type="radio" value="phone" aria-label="...">
                        휴대폰 소액결제
                </li>
            </label>
          </ul>
    </div>
      
    <div id="footer" >
        <div id="info">
            <div class="mb-3 row">
                <label class="col-4">결제수단</label>
                <div class="col-8" id="method" style="text-align:right;"></div>
            </div>
            <div class="mb-3 row">
                <label class="col-5" style="font-size:18px; color:#7e7e7e">총 결제요금</label>
                <div class="col-7" id="total_fee" style="text-align:right;"></div>
            </div>
        </div>
    
    
        <button type="submit"id="pay_submit">결 제 하 기</button>
    </div>
</div>

<script>

    $('#inputPoint').on('change', function() {
        text = $("#inputPoint option:checked").text()
        $('#total_fee').text(text);
    });

    $('input[name="inputMethod"]').on('click', function() {
        var radioId = $('input[name="inputMethod"]:checked').val();
        var text = $("label[for='"+radioId+"']").text().trim();
        $('#method').text(text);
    })

    var IMP = window.IMP; // 생략 가능
    IMP.init("imp56972993"); // 예: imp00000000
    
    function requestPay() {
        let name = $('#total_fee').text();
        let method = $('method').text();

        if(name.length < 1 || method.length < 1) {
            alert("먼저 결제수단/포인트를 선택하세요.")
            return -1;
        }
        IMP.request_pay({
            pg : 'inicis',
            pay_method : 'card',
            merchant_uid : 'merchant_' + new Date().getTime(),
            name : '주문명:결제테스트',
            amount : 14000,
            buyer_email : 'iamport@siot.do',
            buyer_name : '구매자이름',
            buyer_tel : '010-1234-5678',
            buyer_addr : '서울특별시 강남구 삼성동',
            buyer_postcode : '123-456'
        }, function(rsp) {
            if ( rsp.success ) {
            //[1] 서버단에서 결제정보 조회를 위해 jQuery ajax로 imp_uid 전달하기
            jQuery.ajax({
            url: "/payments/complete", //cross-domain error가 발생하지 않도록 동일한 도메인으로 전송
            type: 'POST',
            dataType: 'json',
            data: {
            imp_uid : rsp.imp_uid
            //기타 필요한 데이터가 있으면 추가 전달
            }
            }).done(function(data) {
            //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
            if ( everythings_fine ) {
            var msg = '결제가 완료되었습니다.';
            msg += '\n고유ID : ' + rsp.imp_uid;
            msg += '\n상점 거래ID : ' + rsp.merchant_uid;
            msg += '\결제 금액 : ' + rsp.paid_amount;
            msg += '카드 승인번호 : ' + rsp.apply_num;

            alert(msg);
            } else {
            //[3] 아직 제대로 결제가 되지 않았습니다.
            //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
            }
            });
            } else {
                var msg = '결제에 실패하였습니다.';
                msg += '에러내용 : ' + rsp.error_msg;

                alert(msg);
            }
        });
    }
</script>

{% endblock %}